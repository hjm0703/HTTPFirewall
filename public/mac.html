<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MACç™½åå• - WFP Firewall</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">ğŸ”¥ WFP Firewall</a>
        <div class="navbar-nav">
            <a href="ip.html" class="nav-link">âœ… IPç™½åå•</a>
            <a href="mac.html" class="nav-link active">ğŸ”— MACç™½åå•</a>
            <a href="ports.html" class="nav-link">ğŸ”Œ ç«¯å£ç®¡ç†</a>
            <a href="lan.html" class="nav-link">ğŸŒ å±€åŸŸç½‘</a>
            <a href="logs.html" class="nav-link">ğŸ“‹ æ‹¦æˆªæ—¥å¿—</a>
            <a href="cve.html" class="nav-link">ğŸ›¡ï¸ CVEé˜²æŠ¤</a>
        </div>
    </nav>
    
    <!-- ç²’å­èƒŒæ™¯ -->
    <canvas id="particles-canvas"></canvas>
    
    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <div class="panel mac-panel">
                <h2>MAC åœ°å€ç™½åå•</h2>
                <div class="cve-card medium">
                    <div class="cve-title">âš ï¸ MAC ç»‘å®šé˜²æŠ¤</div>
                    <div class="cve-desc">å¯ç”¨åï¼Œåªæœ‰ç™½åå•ä¸­çš„ MAC åœ°å€æ‰èƒ½ä¸æœ¬æœºé€šä¿¡ã€‚æœªåœ¨ç™½åå•ä¸­çš„è®¾å¤‡å°†è¢«æ‹’ç»å…¥ç«™è¿æ¥ï¼Œæœ‰æ•ˆé˜²æ­¢ IP ä¼ªé€ æ”»å‡»ã€‚</div>
                </div>
                <div class="cve-card" style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>MAC è¿‡æ»¤</strong><br><small style="color:var(--text-muted)" id="macFilterDesc">æœªå¯ç”¨</small></div>
                    <label class="toggle-switch"><input type="checkbox" id="macToggle" onchange="toggleMacFilter()"><span class="toggle-slider"></span></label>
                </div>
                
                <h2 style="margin-top:25px">æ·»åŠ  MAC åœ°å€</h2>
                <form id="addMacForm">
                    <div class="form-row">
                        <div class="form-group"><label>MACåœ°å€</label><input type="text" id="macAddr" placeholder="AA:BB:CC:DD:EE:FF"></div>
                        <div class="form-group"><label>æè¿°</label><input type="text" id="macDescInput" placeholder="è®¾å¤‡åç§°"></div>
                        <div class="form-group" style="flex:0.5"><label>å…³è”IP</label><input type="text" id="macIpv4" placeholder="å¯é€‰"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </form>
                
                <div class="header-actions" style="margin-top:20px">
                    <h2>ç™½åå•åˆ—è¡¨</h2>
                    <div class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="loadMacs()">åˆ·æ–°</button>
                        <button class="btn btn-danger btn-sm" onclick="clearMacs()">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="btn btn-success btn-sm" onclick="addAllLanToMac()">ä»å±€åŸŸç½‘æ‰«ææ·»åŠ æ‰€æœ‰è®¾å¤‡</button>
                </div>
                <div class="mac-list" id="macList"></div>
            </div>
        </div>
    </main>
    
    <div class="toast" id="toast"></div>

    <script src="common.js"></script>
    <script>
        let macData = [];
        
        const loadMacs = async () => { 
            try { 
                const r = await fetch('/api/mac'); 
                macData = await r.json(); 
                renderMacs(); 
            } catch(e){ showToast('åŠ è½½MACå¤±è´¥', 'error'); } 
        };
        
        const renderMacs = () => { 
            const el = document.getElementById('macList'); 
            if (!macData.length) { 
                el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”—</div><p>æš‚æ— MACç™½åå•</p></div>'; 
                return; 
            } 
            el.innerHTML = macData.map(m => '<div class="mac-item"><div class="mac-info"><span class="mac-addr">' + m.mac + '</span><span style="color:var(--text-muted)">' + (m.description || '-') + '</span><span class="device-ip ipv4">' + (m.ipv4 || '-') + '</span></div><button class="btn btn-danger btn-sm" onclick="removeMac(\'' + m.mac + '\')">ç§»é™¤</button></div>').join(''); 
        };
        
        const toggleMacFilter = async () => { 
            const on = document.getElementById('macToggle').checked; 
            try { 
                const params = new URLSearchParams(); 
                params.append('enabled', on ? 'true' : 'false'); 
                await fetch('/api/mac/toggle', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                document.getElementById('macFilterDesc').textContent = on ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'; 
                showToast(on ? 'MACè¿‡æ»¤å·²å¼€å¯' : 'MACè¿‡æ»¤å·²å…³é—­'); 
            } catch(e) { 
                document.getElementById('macToggle').checked = !on; 
            } 
        };
        
        document.getElementById('addMacForm').onsubmit = async e => { 
            e.preventDefault(); 
            const mac = document.getElementById('macAddr').value.trim(), desc = document.getElementById('macDescInput').value.trim(), ipv4 = document.getElementById('macIpv4').value.trim(); 
            if (!mac) return; 
            try { 
                const params = new URLSearchParams(); 
                params.append('mac', mac); 
                params.append('description', desc); 
                params.append('ipv4', ipv4); 
                const r = await fetch('/api/mac', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                const d = await r.json(); 
                if (d.success) { 
                    showToast('å·²æ·»åŠ '); 
                    document.getElementById('addMacForm').reset(); 
                    loadMacs(); 
                } else showToast(d.error, 'error'); 
            } catch(e){ 
                showToast('å¤±è´¥', 'error'); 
            } 
        };
        
        const removeMac = async mac => { 
            if (!confirm('ç§»é™¤ ' + mac + '?')) return; 
            try { 
                const params = new URLSearchParams(); 
                params.append('mac', mac); 
                await fetch('/api/mac', {method:'DELETE', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                showToast('å·²ç§»é™¤'); 
                loadMacs(); 
            } catch(e){} 
        };
        
        const clearMacs = async () => { 
            if (!confirm('æ¸…ç©ºæ‰€æœ‰MACç™½åå•?')) return; 
            await fetch('/api/mac/all', {method:'DELETE'}); 
            showToast('å·²æ¸…ç©º'); 
            loadMacs(); 
        };
        
        const addAllLanToMac = async () => { 
            try {
                const r = await fetch('/api/lan');
                const lanData = await r.json();
                
                if (!lanData.length) { 
                    showToast('è¯·å…ˆåœ¨å±€åŸŸç½‘é¡µé¢æ‰«æ', 'error'); 
                    return; 
                }
                let added = 0;
                for (const d of lanData) {
                    if (d.mac && d.mac !== '-') {
                        try { 
                            const params = new URLSearchParams(); 
                            params.append('mac', d.mac); 
                            params.append('description', d.hostname); 
                            params.append('ipv4', d.ipv4); 
                            const r = await fetch('/api/mac', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                            if ((await r.json()).success) added++; 
                        } catch(e){}
                    }
                }
                showToast('å·²æ·»åŠ  ' + added + ' ä¸ªè®¾å¤‡åˆ°ç™½åå•');
                loadMacs();
            } catch(e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        };
        
        const loadStatus = async () => {
            try {
                const r = await fetch('/api/status');
                const d = await r.json();
                document.getElementById('macToggle').checked = d.macFilterEnabled;
                document.getElementById('macFilterDesc').textContent = d.macFilterEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
            } catch(e){}
        };
        
        // URL å‚æ•°å¤„ç†
        const handleUrlParams = () => {
            const params = new URLSearchParams(window.location.search);
            const mac = params.get('mac');
            const desc = params.get('desc');
            const ipv4 = params.get('ipv4');
            if (mac) {
                document.getElementById('macAddr').value = mac;
                if (desc) document.getElementById('macDescInput').value = desc;
                if (ipv4) document.getElementById('macIpv4').value = ipv4;
            }
        };
        
        // åˆå§‹åŒ–
        loadMacs();
        loadStatus();
        handleUrlParams();
    </script>
</body>
</html>
