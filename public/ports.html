<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¯å£ç®¡ç† - WFP Firewall</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">ğŸ”¥ WFP Firewall</a>
        <div class="navbar-nav">
            <a href="ip.html" class="nav-link">âœ… IPç™½åå•</a>
            <a href="mac.html" class="nav-link">ğŸ”— MACç™½åå•</a>
            <a href="ports.html" class="nav-link active">ğŸ”Œ ç«¯å£ç®¡ç†</a>
            <a href="lan.html" class="nav-link">ğŸŒ å±€åŸŸç½‘</a>
            <a href="logs.html" class="nav-link">ğŸ“‹ æ‹¦æˆªæ—¥å¿—</a>
            <a href="cve.html" class="nav-link">ğŸ›¡ï¸ CVEé˜²æŠ¤</a>
        </div>
    </nav>
    
    <!-- ç²’å­èƒŒæ™¯ -->
    <canvas id="particles-canvas"></canvas>
    
    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <div class="panel port-panel">
                <h2>ğŸ”Œ ç«¯å£ä¸è¿æ¥ç®¡ç†</h2>
                <div class="cve-card medium">
                    <div class="cve-title">ç«¯å£çŠ¶æ€ç›‘æ§</div>
                    <div class="cve-desc">æŸ¥çœ‹å½“å‰ç³»ç»Ÿå¼€æ”¾çš„ç«¯å£å’Œç½‘ç»œè¿æ¥çŠ¶æ€ï¼Œæ”¯æŒæŒ‰ç«¯å£æˆ–è¿›ç¨‹æ¸…ç†å¼‚å¸¸è¿æ¥ã€‚</div>
                </div>
                
                <div class="header-actions" style="margin-top:20px">
                    <h2>ç«¯å£åˆ—è¡¨</h2>
                    <div class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="loadPorts()">åˆ·æ–°</button>
                    </div>
                </div>
                
                <div class="form-row" style="margin-bottom:15px">
                    <div class="form-group" style="flex:0.3">
                        <label>åè®®ç­›é€‰</label>
                        <select id="portProtocolFilter" onchange="filterPorts()" style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text-primary);font-size:13px">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:0.3">
                        <label>çŠ¶æ€ç­›é€‰</label>
                        <select id="portStateFilter" onchange="filterPorts()" style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text-primary);font-size:13px">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="listening">ç›‘å¬ä¸­</option>
                            <option value="established">å·²å»ºç«‹</option>
                            <option value="time_wait">TIME_WAIT</option>
                            <option value="close_wait">CLOSE_WAIT</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:0.4">
                        <label>æœç´¢</label>
                        <input type="text" id="portSearch" placeholder="ç«¯å£/è¿›ç¨‹å..." oninput="filterPorts()">
                    </div>
                </div>
                
                <div class="quick-actions" style="margin-bottom:15px">
                    <button class="btn btn-success btn-sm" onclick="loadListeningPorts()">ä»…æ˜¾ç¤ºç›‘å¬ç«¯å£</button>
                    <button class="btn btn-success btn-sm" onclick="loadEstablishedPorts()">ä»…æ˜¾ç¤ºå·²å»ºç«‹è¿æ¥</button>
                </div>
                
                <div class="port-list" id="portList"></div>
                
                <h2 style="margin-top:25px">å…³é—­è¿æ¥</h2>
                <form id="closePortForm" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
                    <div class="form-group" style="flex:0.3;min-width:120px">
                        <label>ç«¯å£å·</label>
                        <input type="number" id="closePortNum" placeholder="ç«¯å£å·" min="1" max="65535">
                    </div>
                    <div class="form-group" style="flex:0.2;min-width:100px">
                        <label>åè®®</label>
                        <select id="closePortProtocol" style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text-primary);font-size:13px">
                            <option value="tcp">TCP</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-danger">å…³é—­ç«¯å£è¿æ¥</button>
                </form>
                
                <form id="closePidForm" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-top:15px">
                    <div class="form-group" style="flex:0.3;min-width:120px">
                        <label>è¿›ç¨‹ID (PID)</label>
                        <input type="number" id="closePidNum" placeholder="è¿›ç¨‹ID" min="1">
                    </div>
                    <button type="submit" class="btn btn-danger">å…³é—­è¿›ç¨‹è¿æ¥</button>
                </form>
            </div>
        </div>
    </main>
    
    <div class="toast" id="toast"></div>

    <script src="common.js"></script>
    <script>
        let portData = [];
        
        const loadPorts = async () => { 
            try { 
                const r = await fetch('/api/ports'); 
                portData = await r.json(); 
                renderPorts(); 
            } catch(e){ showToast('åŠ è½½ç«¯å£å¤±è´¥', 'error'); } 
        };
        
        const loadListeningPorts = async () => { 
            try { 
                const r = await fetch('/api/ports/listening'); 
                portData = await r.json(); 
                renderPorts(); 
                document.getElementById('portProtocolFilter').value = 'all';
                document.getElementById('portStateFilter').value = 'listening';
            } catch(e){ showToast('åŠ è½½å¤±è´¥', 'error'); } 
        };
        
        const loadEstablishedPorts = async () => { 
            try { 
                const r = await fetch('/api/ports/established'); 
                portData = await r.json(); 
                renderPorts(); 
                document.getElementById('portProtocolFilter').value = 'tcp';
                document.getElementById('portStateFilter').value = 'established';
            } catch(e){ showToast('åŠ è½½å¤±è´¥', 'error'); } 
        };
        
        const renderPorts = (filter = {}) => { 
            const el = document.getElementById('portList'); 
            let d = portData;
            
            if (filter.protocol && filter.protocol !== 'all') {
                d = d.filter(p => p.protocol.toLowerCase().includes(filter.protocol.toLowerCase()));
            }
            if (filter.state && filter.state !== 'all') {
                d = d.filter(p => p.state.toLowerCase() === filter.state.toLowerCase());
            }
            if (filter.search) {
                const s = filter.search.toLowerCase();
                d = d.filter(p => 
                    p.port.toString().includes(s) || 
                    p.processName.toLowerCase().includes(s) ||
                    p.localAddress.toLowerCase().includes(s)
                );
            }
            
            if (!d.length) { 
                el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”Œ</div><p>æš‚æ— ç«¯å£æ•°æ®</p></div>'; 
                return; 
            } 
            
            const stateColors = {
                'LISTENING': 'var(--success)',
                'ESTABLISHED': 'var(--info)',
                'TIME_WAIT': 'var(--warning)',
                'CLOSE_WAIT': 'var(--danger)',
                'SYN_SENT': 'var(--orange)',
                'SYN_RCVD': 'var(--purple)'
            };
            
            el.innerHTML = d.map(p => {
                const stateColor = stateColors[p.state] || 'var(--text-muted)';
                const protocolBadge = p.protocol.includes('6') ? 
                    '<span class="ip-type-badge ipv6" style="font-size:9px">' + p.protocol + '</span>' : 
                    '<span class="ip-type-badge ipv4" style="font-size:9px">' + p.protocol + '</span>';
                
                return '<div class="port-item" style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--surface);border-radius:10px;margin-bottom:8px;border:1px solid var(--border-light);transition:all 0.3s ease">' +
                    '<div style="display:flex;align-items:center;gap:15px;flex:1;min-width:0">' +
                        '<span style="font-family:Consolas,monospace;font-size:16px;font-weight:600;color:var(--accent-start);min-width:60px">' + p.port + '</span>' +
                        protocolBadge +
                        '<span style="padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;background:' + stateColor + '22;color:' + stateColor + '">' + p.state + '</span>' +
                        '<span style="font-family:Consolas,monospace;font-size:11px;color:var(--text-muted);max-width:120px;overflow:hidden;text-overflow:ellipsis" title="' + p.localAddress + '">' + p.localAddress + '</span>' +
                        (p.remoteAddress !== '-' ? '<span style="font-size:11px;color:var(--text-faint)">â†’ ' + p.remoteAddress + (p.remotePort ? ':' + p.remotePort : '') + '</span>' : '') +
                    '</div>' +
                    '<div style="display:flex;align-items:center;gap:10px">' +
                        '<span style="font-size:11px;color:var(--text-muted);max-width:100px;overflow:hidden;text-overflow:ellipsis" title="' + p.processName + '">' + p.processName + '</span>' +
                        '<span style="font-family:Consolas,monospace;font-size:10px;color:var(--text-faint);min-width:50px">PID:' + p.pid + '</span>' +
                        (p.state !== 'LISTENING' && p.protocol.includes('TCP') ? '<button class="btn btn-danger btn-sm" onclick="closePort(' + p.port + ',\'' + p.pid + '\')">å…³é—­</button>' : '') +
                    '</div>' +
                '</div>';
            }).join(''); 
        };
        
        const filterPorts = () => {
            renderPorts({
                protocol: document.getElementById('portProtocolFilter').value,
                state: document.getElementById('portStateFilter').value,
                search: document.getElementById('portSearch').value
            });
        };
        
        const closePort = async (port, pid) => {
            if (!confirm('å…³é—­ç«¯å£ ' + port + ' çš„è¿æ¥ï¼Ÿ')) return;
            try {
                const params = new URLSearchParams();
                params.append('port', port);
                params.append('protocol', 'tcp');
                const r = await fetch('/api/ports/close', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}});
                const d = await r.json();
                if (d.success) {
                    showToast(d.message);
                    loadPorts();
                } else showToast(d.error, 'error');
            } catch(e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        };
        
        document.getElementById('closePortForm').onsubmit = async e => {
            e.preventDefault();
            const port = document.getElementById('closePortNum').value.trim();
            const protocol = document.getElementById('closePortProtocol').value;
            if (!port) {
                showToast('è¯·è¾“å…¥ç«¯å£å·', 'error');
                return;
            }
            try {
                const params = new URLSearchParams();
                params.append('port', port);
                params.append('protocol', protocol);
                const r = await fetch('/api/ports/close', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}});
                const d = await r.json();
                if (d.success) {
                    showToast(d.message);
                    document.getElementById('closePortNum').value = '';
                    loadPorts();
                } else showToast(d.error, 'error');
            } catch(e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        };
        
        document.getElementById('closePidForm').onsubmit = async e => {
            e.preventDefault();
            const pid = document.getElementById('closePidNum').value.trim();
            if (!pid) {
                showToast('è¯·è¾“å…¥è¿›ç¨‹ID', 'error');
                return;
            }
            if (!confirm('å…³é—­è¿›ç¨‹ PID:' + pid + ' çš„æ‰€æœ‰ç½‘ç»œè¿æ¥ï¼Ÿ')) return;
            try {
                const params = new URLSearchParams();
                params.append('pid', pid);
                const r = await fetch('/api/ports/close-by-pid', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}});
                const d = await r.json();
                if (d.success) {
                    showToast(d.message);
                    document.getElementById('closePidNum').value = '';
                    loadPorts();
                } else showToast(d.error, 'error');
            } catch(e) {
                showToast('æ“ä½œå¤±è´¥', 'error');
            }
        };
        
        // åˆå§‹åŒ–
        loadPorts();
    </script>
</body>
</html>