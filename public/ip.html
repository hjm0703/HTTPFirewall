<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPç™½åå• - WFP Firewall</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">ğŸ”¥ WFP Firewall</a>
        <div class="navbar-nav">
            <a href="ip.html" class="nav-link active">âœ… IPç™½åå•</a>
            <a href="mac.html" class="nav-link">ğŸ”— MACç™½åå•</a>
            <a href="ports.html" class="nav-link">ğŸ”Œ ç«¯å£ç®¡ç†</a>
            <a href="lan.html" class="nav-link">ğŸŒ å±€åŸŸç½‘</a>
            <a href="logs.html" class="nav-link">ğŸ“‹ æ‹¦æˆªæ—¥å¿—</a>
            <a href="cve.html" class="nav-link">ğŸ›¡ï¸ CVEé˜²æŠ¤</a>
        </div>
    </nav>
    
    <!-- ç²’å­èƒŒæ™¯ -->
    <canvas id="particles-canvas"></canvas>
    
    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <div class="panel ip-panel">
                <h2>IP åœ°å€ç™½åå•</h2>
                <div class="cve-card medium">
                    <div class="cve-title">âš ï¸ IP ç™½åå•é˜²æŠ¤</div>
                    <div class="cve-desc">å¯ç”¨åï¼Œåªæœ‰ç™½åå•ä¸­çš„ IP åœ°å€æ‰èƒ½ä¸æœ¬æœºå»ºç«‹å…¥ç«™è¿æ¥ã€‚æœªåœ¨ç™½åå•ä¸­çš„ IP å°†è¢«æ‹’ç»ï¼Œæœ‰æ•ˆé˜²æ­¢æœªæˆæƒè®¿é—®ã€‚</div>
                </div>
                <div class="cve-card" style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>IP è¿‡æ»¤</strong><br><small style="color:var(--text-muted)" id="ipFilterDesc">æœªå¯ç”¨</small></div>
                    <label class="toggle-switch"><input type="checkbox" id="ipToggle" onchange="toggleIpFilter()"><span class="toggle-slider"></span></label>
                </div>
                
                <h2 style="margin-top:25px">æ·»åŠ  IP åœ°å€</h2>
                <form id="addForm">
                    <div class="form-row">
                        <div class="form-group"><label>IPåœ°å€</label><input type="text" id="ipAddr" placeholder="192.168.1.1 æˆ– 2001:db8::1"></div>
                        <div class="form-group"><label>æè¿°</label><input type="text" id="ipDesc" placeholder="å¤‡æ³¨"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </form>
                
                <div class="header-actions" style="margin-top:20px">
                    <h2>ç™½åå•åˆ—è¡¨</h2>
                    <div class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="loadIps()">åˆ·æ–°</button>
                        <button class="btn btn-danger btn-sm" onclick="clearAllIps()">æ¸…ç©º</button>
                    </div>
                </div>
                <div class="search-box"><input type="text" id="search" placeholder="æœç´¢..." oninput="filterIps()"></div>
                <div class="ip-list" id="ipList"></div>
            </div>
        </div>
    </main>
    
    <div class="toast" id="toast"></div>

    <script src="common.js"></script>
    <script>
        let ipData = [];
        
        const loadIps = async () => { 
            try { 
                const r = await fetch('/api/ips'); 
                ipData = await r.json(); 
                renderIps(); 
            } catch(e){ showToast('åŠ è½½å¤±è´¥', 'error'); } 
        };
        
        const renderIps = (f = '') => { 
            const el = document.getElementById('ipList'); 
            const d = ipData.filter(i => i.ip.includes(f) || i.description.includes(f)); 
            if (!d.length) { 
                el.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><p>æš‚æ— IPç™½åå•</p></div>'; 
                return; 
            } 
            el.innerHTML = d.map(i => '<div class="ip-item"><div class="device-info"><span class="ip-type-badge ' + (i.ip_type === 'IPv6' ? 'ipv6' : 'ipv4') + '">' + (i.ip_type || 'IPv4') + '</span><span class="ip-address">' + i.ip + '</span><span class="ip-description">' + (i.description || '-') + '</span></div><button class="btn btn-danger btn-sm" onclick="removeIp(\'' + i.ip + '\')">ç§»é™¤</button></div>').join(''); 
        };
        
        const filterIps = () => renderIps(document.getElementById('search').value);
        
        const toggleIpFilter = async () => { 
            const on = document.getElementById('ipToggle').checked; 
            try { 
                const params = new URLSearchParams(); 
                params.append('enabled', on ? 'true' : 'false'); 
                await fetch('/api/ips/toggle', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                document.getElementById('ipFilterDesc').textContent = on ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'; 
                showToast(on ? 'IPè¿‡æ»¤å·²å¼€å¯' : 'IPè¿‡æ»¤å·²å…³é—­'); 
            } catch(e) { 
                document.getElementById('ipToggle').checked = !on; 
            } 
        };
        
        document.getElementById('addForm').onsubmit = async e => { 
            e.preventDefault(); 
            const ip = document.getElementById('ipAddr').value.trim(), desc = document.getElementById('ipDesc').value.trim(); 
            if (!ip) return; 
            try { 
                const params = new URLSearchParams(); 
                params.append('ip', ip); 
                params.append('description', desc); 
                const r = await fetch('/api/ips', {method:'POST', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                const d = await r.json(); 
                if (d.success) { 
                    showToast('å·²æ·»åŠ åˆ°ç™½åå•'); 
                    document.getElementById('addForm').reset(); 
                    loadIps(); 
                } else showToast(d.error, 'error'); 
            } catch(e){ 
                showToast('å¤±è´¥', 'error'); 
            } 
        };
        
        const removeIp = async ip => { 
            if (!confirm('ä»ç™½åå•ç§»é™¤ ' + ip + '?')) return; 
            try { 
                const params = new URLSearchParams(); 
                params.append('ip', ip); 
                await fetch('/api/ips', {method:'DELETE', body:params, headers:{'Content-Type':'application/x-www-form-urlencoded'}}); 
                showToast('å·²ç§»é™¤'); 
                loadIps(); 
            } catch(e){} 
        };
        
        const clearAllIps = async () => { 
            if (!confirm('æ¸…ç©ºæ‰€æœ‰IPç™½åå•?')) return; 
            await fetch('/api/ips/all', {method:'DELETE'}); 
            showToast('å·²æ¸…ç©º'); 
            loadIps(); 
        };
        
        const loadStatus = async () => {
            try {
                const r = await fetch('/api/status');
                const d = await r.json();
                document.getElementById('ipToggle').checked = d.ipFilterEnabled;
                document.getElementById('ipFilterDesc').textContent = d.ipFilterEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
            } catch(e){}
        };
        
        // URL å‚æ•°å¤„ç†
        const handleUrlParams = () => {
            const params = new URLSearchParams(window.location.search);
            const ip = params.get('ip');
            const desc = params.get('desc');
            if (ip) {
                document.getElementById('ipAddr').value = ip;
                if (desc) document.getElementById('ipDesc').value = desc;
            }
        };
        
        // åˆå§‹åŒ–
        loadIps();
        loadStatus();
        handleUrlParams();
    </script>
</body>
</html>