<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±€åŸŸç½‘æ‰«æ - WFP Firewall</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hostname-wrapper { display: flex; align-items: center; gap: 8px; }
        .custom-badge { 
            font-size: 9px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            background: rgba(34, 197, 94, 0.2); 
            color: var(--success);
            font-weight: 600;
        }
        .btn-edit { 
            padding: 4px 8px; 
            font-size: 11px; 
            background: rgba(59, 130, 246, 0.2); 
            color: var(--info); 
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .btn-edit:hover { background: rgba(59, 130, 246, 0.3); }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }
        .modal h3 { margin-bottom: 16px; color: var(--text-primary); }
        .modal input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .modal input:focus { outline: none; border-color: var(--accent-start); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    </style>
</head>
<body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">ğŸ”¥ WFP Firewall</a>
        <div class="navbar-nav">
            <a href="ip.html" class="nav-link">âœ… IPç™½åå•</a>
            <a href="mac.html" class="nav-link">ğŸ”— MACç™½åå•</a>
            <a href="ports.html" class="nav-link">ğŸ”Œ ç«¯å£ç®¡ç†</a>
            <a href="lan.html" class="nav-link active">ğŸŒ å±€åŸŸç½‘</a>
            <a href="logs.html" class="nav-link">ğŸ“‹ æ‹¦æˆªæ—¥å¿—</a>
            <a href="cve.html" class="nav-link">ğŸ›¡ï¸ CVEé˜²æŠ¤</a>
        </div>
    </nav>
    
    <!-- ç²’å­èƒŒæ™¯ -->
    <canvas id="particles-canvas"></canvas>
    
    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <div class="panel lan-panel">
                <div class="header-actions">
                    <h2>ğŸŒ å±€åŸŸç½‘è®¾å¤‡</h2>
                    <button class="btn btn-primary btn-sm" onclick="scanLan()">æ‰«æ</button>
                </div>
                <div class="cve-card medium">
                    <div class="cve-title">å±€åŸŸç½‘è®¾å¤‡æ‰«æ</div>
                    <div class="cve-desc">æ‰«æå±€åŸŸç½‘ä¸­çš„è®¾å¤‡ï¼ŒæŸ¥çœ‹ IPã€MAC åœ°å€ç­‰ä¿¡æ¯ã€‚å¯ä»¥ä¿®æ”¹è®¾å¤‡ä¸»æœºåå¹¶ä¿å­˜ï¼Œæˆ–æ·»åŠ åˆ°ç™½åå•ã€‚</div>
                </div>
                <div class="device-list" id="deviceList"></div>
            </div>
        </div>
    </main>
    
    <!-- ä¿®æ”¹ä¸»æœºåå¼¹çª— -->
    <div class="modal-overlay" id="hostnameModal">
        <div class="modal">
            <h3>ä¿®æ”¹ä¸»æœºå</h3>
            <input type="text" id="hostnameInput" placeholder="è¾“å…¥è‡ªå®šä¹‰ä¸»æœºå">
            <input type="hidden" id="editingMac">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeHostnameModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="resetHostname()">é‡ç½®</button>
                <button class="btn btn-primary" onclick="saveHostname()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script src="common.js"></script>
    <script>
        let lanData = [];
        let customHostnames = {};
        
        const loadHostnames = async () => {
            try {
                const r = await fetch('/api/lan/hostnames');
                customHostnames = await r.json();
            } catch(e) {}
        };
        
        const loadLan = async () => { 
            try { 
                const r = await fetch('/api/lan'); 
                lanData = await r.json();
                await loadHostnames();
                renderLan(); 
            } catch(e){} 
        };
        
        const getDisplayName = (device) => {
            const custom = customHostnames[device.mac];
            return custom ? custom : device.hostname;
        };
        
        const hasCustomHostname = (mac) => {
            return customHostnames[mac] && customHostnames[mac] !== '';
        };
        
        const renderLan = () => { 
            const el = document.getElementById('deviceList'); 
            if (!lanData.length) { 
                el.innerHTML = '<div class="empty-state"><div class="icon">ğŸŒ</div><p>ç‚¹å‡»æ‰«ææŸ¥çœ‹å±€åŸŸç½‘è®¾å¤‡</p></div>'; 
                return; 
            } 
            el.innerHTML = lanData.map(d => {
                const displayName = getDisplayName(d);
                const isCustom = hasCustomHostname(d.mac);
                return '<div class="device-item">' +
                    '<div class="device-info">' +
                        '<div class="hostname-wrapper">' +
                            '<span class="device-hostname">' + displayName + '</span>' +
                            (isCustom ? '<span class="custom-badge">è‡ªå®šä¹‰</span>' : '') +
                            '<button class="btn btn-edit" onclick="openHostnameModal(\'' + d.mac + '\', \'' + escapeHtml(displayName) + '\')">âœï¸</button>' +
                        '</div>' +
                        '<span class="device-ip ipv4">' + d.ipv4 + '</span>' +
                        '<span class="mac-addr">' + d.mac + '</span>' +
                    '</div>' +
                    '<div class="actions">' +
                        '<button class="btn btn-success btn-sm" onclick="addIpFromLan(\'' + d.ipv4 + '\',\'' + escapeHtml(displayName) + '\')">åŠ å…¥IPç™½åå•</button>' +
                        '<button class="btn btn-success btn-sm" onclick="addMacFromLan(\'' + d.mac + '\',\'' + escapeHtml(displayName) + '\',\'' + d.ipv4 + '\')">åŠ å…¥MACç™½åå•</button>' +
                    '</div>' +
                '</div>';
            }).join(''); 
        };
        
        const escapeHtml = (str) => {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        };
        
        const openHostnameModal = (mac, currentName) => {
            document.getElementById('editingMac').value = mac;
            document.getElementById('hostnameInput').value = customHostnames[mac] || '';
            document.getElementById('hostnameModal').classList.add('show');
            document.getElementById('hostnameInput').focus();
        };
        
        const closeHostnameModal = () => {
            document.getElementById('hostnameModal').classList.remove('show');
        };
        
        const saveHostname = async () => {
            const mac = document.getElementById('editingMac').value;
            const hostname = document.getElementById('hostnameInput').value.trim();
            
            try {
                const params = new URLSearchParams();
                params.append('mac', mac);
                params.append('hostname', hostname);
                const r = await fetch('/api/lan/hostname', { method: 'POST', body: params });
                const result = await r.json();
                
                if (result.success) {
                    if (hostname) {
                        customHostnames[mac] = hostname;
                    } else {
                        delete customHostnames[mac];
                    }
                    renderLan();
                    showToast('ä¸»æœºåå·²ä¿å­˜');
                    closeHostnameModal();
                } else {
                    showToast(result.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch(e) {
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        };
        
        const resetHostname = async () => {
            const mac = document.getElementById('editingMac').value;
            
            try {
                const params = new URLSearchParams();
                params.append('mac', mac);
                const r = await fetch('/api/lan/hostname/delete', { method: 'POST', body: params });
                const result = await r.json();
                
                if (result.success) {
                    delete customHostnames[mac];
                    renderLan();
                    showToast('å·²é‡ç½®ä¸ºé»˜è®¤ä¸»æœºå');
                    closeHostnameModal();
                } else {
                    showToast(result.error || 'é‡ç½®å¤±è´¥', 'error');
                }
            } catch(e) {
                showToast('é‡ç½®å¤±è´¥', 'error');
            }
        };
        
        const scanLan = async () => { 
            try { 
                const r = await fetch('/api/lan/scan', {method:'POST'}); 
                lanData = await r.json();
                await loadHostnames();
                renderLan(); 
                showToast('æ‰«æå®Œæˆï¼Œå‘ç° ' + lanData.length + ' ä¸ªè®¾å¤‡'); 
            } catch(e){ 
                showToast('æ‰«æå¤±è´¥', 'error'); 
            } 
        };
        
        const addIpFromLan = (ip, name) => { 
            if (ip === '-') return;
            window.location.href = 'ip.html?ip=' + encodeURIComponent(ip) + '&desc=' + encodeURIComponent(name);
        };
        
        const addMacFromLan = (mac, name, ip) => { 
            window.location.href = 'mac.html?mac=' + encodeURIComponent(mac) + '&desc=' + encodeURIComponent(name) + '&ipv4=' + encodeURIComponent(ip);
        };
        
        // åˆå§‹åŒ–
        loadLan();
    </script>
</body>
</html>